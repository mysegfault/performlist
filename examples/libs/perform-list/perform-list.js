/* 
 * performlist: Performlist is an HTML5 library for making fast scrolling lists (like Contact list) 
 * v0.2.4 
 * 
 * By mysegfault <maxime.alexandre@mobile-spot.com>, https://github.com/mysegfault/performlist 
 * MIT Licence 
 * 
 */
define(["pubsub","js-dom-tools","html5-mobile-boilerplate-helper"],function(a,b){"use strict";var c=function(){var a=this;a._options={cssPrefix:"perform-list",listContainer:"container",listContainerElement:null,listContainerParent:"container-parent",listScrollerElement:null,listScroller:"scroller",listScrollerExtraClass:"",dependsOnUlLi:!1,categoryType:"ul",titleType:"li",categoryTitleExtraClass:"",categoryItemExtraClass:"",itemType:"li",useOptimizer:!1,useFilters:!0,usePreventPageScroller:!1,autoStartAfterReady:!0,minItemsForFilters:0},a._vars={scrollingStatusId:0,optimizer:null,filterBuilder:null,filter:null,preventPageScroller:null,listItems:[],itemsType:"",listElement:null,scrollerElement:null,pluginsToLoad:[],isIOS:!1,isAndroid:!1,isAndroidStockBrowser:!1,id:0,fastButtonListInst:null,iScrollInst:null,isStarted:!1}};return c.prototype.init=function(b){var c=this;if(c._vars.isIOS=null!==window.navigator.userAgent.match(/OS .+_.* like/),c._vars.isAndroid=null!==window.navigator.userAgent.match(/Android/),c._vars.isAndroidStockBrowser=null!==window.navigator.userAgent.match(/ Version\//),c._options.usePreventPageScroller=c._vars.isIOS===!0,"object"==typeof b)for(var d in b)"undefined"!=typeof c._options[d]?null!==b[d]?c._options[d]=b[d]:console.error("This option is invalid.",d,b[d]):console.error("This option does not exist.",d);return null!==c._options.listContainerElement&&"nodeName"in c._options.listContainerElement?(c._vars.listElement=c._options.listContainerElement,c._vars.listElement.classList.add(this._getClassName(c._options.listContainer))):(c._vars.listElement=document.querySelector(this._getClassName(c._options.listContainer,!0)),null!==c._vars.listElement.getAttribute("data-id")&&(c._vars.listElement=null)),null===c._vars.listElement?(console.error("Could not find main list container element.",this._getClassName(c._options.listContainer,!0)),void 0):(c._vars.listElement.parentNode.classList.add(this._getClassName(c._options.listContainerParent)),c._vars.id=""+(new Date).getTime()+Math.round(1e5*Math.random()),c._vars.listElement.setAttribute("data-id",c._vars.id),c._vars.isIOS===!0&&c._vars.listElement.classList.add("os-is-ios"),c._vars.isAndroid===!0&&c._vars.isAndroidStockBrowser===!1&&c._vars.listElement.classList.add("os-is-android"),c._vars.listElement.classList.add(c._options.cssPrefix),a.subscribe("mbs.performlist.start."+c._vars.id,function(){c._vars.isStarted!==!0&&c.start()}),a.subscribe("mbs.performlist.stop."+c._vars.id,function(){c._vars.isStarted!==!1&&c.stop()}),a.subscribe("mbs.performlist.ready."+c._vars.id,function(){c._options.autoStartAfterReady===!0&&null===c._vars.filter&&a.publish("mbs.performlist.start."+c._vars.id)}),"function"==typeof window.IScroll&&"function"!=typeof window.iScroll&&(window.iScroll=window.IScroll),this._loadPlugins(),void 0)},c.prototype.getListElement=function(){var a=this;return a._vars.listElement},c.prototype.getId=function(){var a=this;return a._vars.id},c.prototype.start=function(){var a=this;if("function"==typeof window.iScroll){var b=null;"undefined"!=typeof a._vars.listElement.iScroll&&a._vars.listElement.iScroll instanceof window.iScroll&&(b=a._vars.listElement.iScroll),null!==b&&"function"==typeof $&&(b=$(a._vars.listElement).data("iscroll")),b instanceof window.iScroll&&(a._vars.iScrollInst=a._vars.listElement.iScroll=b)}null===a._vars.iScrollInst&&a._vars.listElement.classList.contains("browser-scroll")===!1&&a._vars.listElement.classList.add("browser-scroll"),a._listToListItemClick(a._vars.listElement),a._vars.scrollingStatusId=this._enableScrollingStatus(),a._vars._cb_afterListResize=function(){a._onListResize()},a._vars.listElement.addEventListener("resize",a._vars._cb_afterListResize,!1),a._startListeners(),a._vars.isStarted=!0},c.prototype.stop=function(){var a=this;null!==a._vars.fastButtonListInst&&(a._vars.fastButtonListInst=null),a._vars.scrollingStatusId>0&&window.clearInterval(a._vars.scrollingStatusId),a._vars.listElement.removeEventListener("resize",a._vars._cb_afterListResize,!1),a._stopListeners(),a._vars.isStarted=!1},c.prototype.destroy=function(){var a=this;a._vars.listItems=[],null!==a._vars.iScrollInst&&(a._vars.iScrollInst.scrollTo(0,0,0,!0),a._vars.iScrollInst.destroy(),a._vars.iScrollInst=null),null!==a._vars.filter&&(a._vars.filter.destroy(),a._vars.filter=null),a._vars.isStarted===!0&&a.stop()},c.prototype.setData=function(c){var d=this;if(d.destroy(),c instanceof Array)d._vars.itemsType="array",d._options.categoryType="ul",d._options.itemType="li",this._buildItemsAsArray(c);else{if(!(c instanceof Object))return console.error("Provided data is not an array not an object"),!1;if(d._vars.itemsType="object",d._options.dependsOnUlLi===!1&&(d._options.categoryType="dl",d._options.titleType="dt",d._options.itemType="dd"),null!==d._vars.filterBuilder&&"number"==typeof d._options.minItemsForFilters&&b.objectTotalLength(c)>=d._options.minItemsForFilters){d._vars.filter=new d._vars.filterBuilder;var e={id:d._vars.id,listElement:d._vars.listElement,autoStartAfterReady:d._options.autoStartAfterReady};d._vars.filter.init(e),d._vars.filter.addListSpaceForFilterElement()}this._buildItemsAsObject(c)}if(this._buildListScroller(),null!==d._vars.optimizer?d._vars.optimizer.loadFromElement(d._vars.scrollerElement):this._buildFullListItems(),null!==d._vars.filter){var f=d._vars.listElement.querySelectorAll(this._getClassName("category-title [data-letter]",!0));d._vars.filter.setTitleElements(f)}return a.publish("mbs.performlist.ready."+d._vars.id),!0},c.prototype._getClassName=function(a,b){var c=this;if("string"!=typeof a&&""!==a)return console.error("Invalid parameter",a),"";var d=c._options.cssPrefix+"-"+a;return b===!0&&(d="."+d),d},c.prototype._buildItemsAsArray=function(a){var b=this;if(a instanceof Array==!1)return console.error("Invalid parameter",a),!1;var c=document.createElement(b._options.itemType);c.classList.add(this._getClassName("category-item"));for(var d=a.length,e=0;d>e;e++){var f=c.cloneNode();f.innerHTML=a[e],b._vars.listItems.push(f)}},c.prototype._buildItemsAsObject=function(a){var b=this;if(a instanceof Object==!1)return console.error("Invalid parameter",a),!1;var c=document.createElement(b._options.titleType);c.classList.add(this._getClassName("category-title")),""!==b._options.categoryTitleExtraClass&&c.classList.add(b._options.categoryTitleExtraClass);var d=document.createElement(b._options.itemType);d.classList.add(this._getClassName("category-item")),""!==b._options.categoryItemExtraClass&&d.classList.add(b._options.categoryItemExtraClass);for(var e in a){var f=document.createDocumentFragment(),g=c.cloneNode();null!==b._vars.filter?(g.innerHTML=b._vars.filter.createTitleHTML(e),b._vars.filter.addTitleItem(e)):g.innerHTML=e,f.appendChild(g);for(var h=0;h<a[e].length;h++){var i=d.cloneNode();i.innerHTML=a[e][h],f.appendChild(i)}b._vars.listItems.push(f)}},c.prototype._buildListScroller=function(){var a,b=this;a=null!==b._options.listScrollerElement?b._options.listScrollerElement:document.createElement(b._options.categoryType),a.classList.add(this._getClassName(b._options.listScroller)),""!==b._options.listScrollerExtraClass&&a.classList.add(b._options.listScrollerExtraClass),a.innerHTML='<p class="perform-list-labels">Building...</p>',b._vars.listElement.innerHTML="",b._vars.listElement.appendChild(a),null!==b._vars.preventPageScroller&&b._vars.isIOS===!0&&b._vars.preventPageScroller.preventScrollingOnListParent(b._vars.listElement),b._vars.scrollerElement=a},c.prototype._buildFullListItems=function(){for(var a=this,b=document.createDocumentFragment(),c=a._vars.listItems.length,d=0;c>d;d++){var e=a._vars.listItems[d];b.appendChild(e)}a._vars.scrollerElement.innerHTML="",a._vars.scrollerElement.appendChild(b)},c.prototype._enableScrollingStatus=function(){function a(){c=null!==b._vars.iScrollInst?parseInt(b._vars.iScrollInst.y):b._vars.listElement.scrollTop;var a=c===d;a!==e&&(e=a,e===!0?(f>0&&(window.clearTimeout(f),f=0),f=window.setTimeout(function(){b._vars.listElement.removeAttribute("is-scrolling")},300)):b._vars.listElement.setAttribute("is-scrolling","")),d=c}var b=this;if("number"!=typeof b._vars.listElement.scrollTop)return console.error("This item is not a scrolling list"),void 0;var c=0,d=0,e=!1,f=0;return window.setInterval(a,20)},c.prototype._listToListItemClick=function(c){function d(c){if(c.type!==g)return c.preventDefault(),c.stopPropagation(),void 0;var d=b.findParentNodeWithClassName(c.target.parentNode,e._getClassName(e._options.listContainer));if(null!==d){var f=null!==d.getAttribute("is-disabled"),h=null!==d.getAttribute("is-scrolling");if(h===!0)return c.preventDefault(),c.stopPropagation(),void 0;if(f===!0)return c.preventDefault(),c.stopPropagation(),void 0}var i=b.findParentNodeWithNodeName(c.target,e._options.itemType);if(null!==i){var j={target:c.target,listItem:i};a.publish("mbs.performlist.click."+e._vars.id,j)}}var e=this,f="ontouchend"in document,g=f===!0?"touchend":"click";e._vars.fastButtonListInst=new MBP.fastButton(c,d)},c.prototype._loadPlugins=function(){var a=this,b=!0;a._vars.pluginsToLoad=[],a._vars.pluginsToLoad.filter=!1,a._vars.pluginsToLoad.optimizer=!1,a._vars.pluginsToLoad.preventPageScroller=!1,a._options.useOptimizer===!0&&(b=!1,require(["perform-list-optimizer"],function(b){a._vars.optimizer=new b;var c={id:a._vars.id,listElement:a._vars.listElement,scrollerElement:a._vars.listScroller,listItems:a._vars.listItems};a._vars.optimizer.init(c),a._vars.pluginsToLoad.optimizer=!0,a._areAllPluginsLoaded()})),a._options.useFilters===!0&&(b=!1,require(["perform-list-filter"],function(b){a._vars.filterBuilder=b,a._vars.pluginsToLoad.filter=!0,a._areAllPluginsLoaded()})),a._options.usePreventPageScroller===!0&&(b=!1,require(["perform-list-prevent-page-scroll"],function(b){a._vars.preventPageScroller=b,a._vars.pluginsToLoad.preventPageScroller=!0,a._areAllPluginsLoaded()})),b===!0&&a._areAllPluginsLoaded()},c.prototype._areAllPluginsLoaded=function(){var b=this;b._options.useOptimizer===b._vars.pluginsToLoad.optimizer&&b._options.useFilters===b._vars.pluginsToLoad.filter&&b._options.usePreventPageScroller===b._vars.pluginsToLoad.preventPageScroller&&window.setTimeout(function(){a.publish("mbs.performlist.initialized."+b._vars.id)},0)},c.prototype._onListResize=function(){},c.prototype._startListeners=function(){var b=this,c=0,d={width:0,height:0},e=function(){if(null!==b._vars.listElement){var c=window.getComputedStyle(b._vars.listElement,null),e=!1;d.width!==c.width&&(e=!0,d.width=c.width),d.height!==c.height&&(e=!0,d.height=c.height),e===!0&&a.publish("mbs.performlist.resize."+b._vars.id)}};b._vars._cb_afterWindowResize=function(){c>0&&(window.clearTimeout(c),c=0),c=window.setTimeout(e,500)},window.addEventListener("resize",b._vars._cb_afterWindowResize,!1),b._vars._cb_afterWindowResize()},c.prototype._stopListeners=function(){var a=this;document.removeEventListener("resize",a._vars._cb_afterWindowResize,!1)},c});