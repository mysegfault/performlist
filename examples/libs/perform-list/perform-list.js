/* 
 * performlist: Performlist is an HTML5 library for making fast scrolling lists (like Contact list) 
 * v0.1.8 
 * 
 * By mysegfault <maxime.alexandre@mobile-spot.com>, https://github.com/mysegfault/performlist 
 * MIT Licence 
 * 
 */
define(["html5-mobile-boilerplate/helper","pubsub-js/pubsub","js-dom-tools/js-dom-tools"],function(a,b,c){"use strict";var d=c.useDebug(!1),e=function(){var a=this;a._options={cssPrefix:"perform-list",listContainer:"container",listContainerElement:null,listContainerParent:"container-parent",listScrollerElement:null,listScroller:"scroller",listScrollerExtraClass:"",dependsOnUlLi:!1,categoryType:"ul",titleType:"li",categoryTitleExtraClass:"",categoryItemExtraClass:"",itemType:"li",useOptimizer:!0,useFilters:!0,usePreventPageScroller:!1,autoStartAfterReady:!0,end:""},a._vars={scrollingStatusId:0,optimizer:null,filter:null,preventPageScroller:null,listItems:[],itemsType:"",listElement:null,scrollerElement:null,pluginsToLoad:[],isIOS:!1,isAndroid:!1,id:0,fastButtonListInst:null,iScrollInst:null,isStarted:!1,end:""}};return e.prototype.init=function(a){var c=this;if(c._vars.isIOS=null!==window.navigator.userAgent.match(/OS .+_.* like/),c._vars.isAndroid=null!==window.navigator.userAgent.match(/Android/),c._options.usePreventPageScroller=c._vars.isIOS===!0,"object"==typeof a)for(var e in a)"undefined"!=typeof c._options[e]?null!==a[e]?c._options[e]=a[e]:d.error("This option is invalid.",e,a[e]):d.error("This option does not exist.",e);return null!==c._options.listContainerElement&&"nodeName"in c._options.listContainerElement?(c._vars.listElement=c._options.listContainerElement,c._vars.listElement.classList.add(this._getClassName(c._options.listContainer))):(c._vars.listElement=document.querySelector(this._getClassName(c._options.listContainer,!0)),null!==c._vars.listElement.getAttribute("data-id")&&(c._vars.listElement=null)),null===c._vars.listElement?(d.error("Could not find main list container element.",this._getClassName(c._options.listContainer,!0)),void 0):(c._vars.listElement.parentNode.classList.add(this._getClassName(c._options.listContainerParent)),c._vars.id=""+(new Date).getTime()+Math.round(1e5*Math.random()),c._vars.listElement.setAttribute("data-id",c._vars.id),c._vars.isIOS===!0&&c._vars.listElement.classList.add("os-is-ios"),c._vars.isAndroid===!0&&c._vars.listElement.classList.add("os-is-android"),c._vars.listElement.classList.add(c._options.cssPrefix),b.subscribe("mbs.performlist.start."+c._vars.id,function(){c._vars.isStarted!==!0&&(c.start(),c._vars.isStarted=!0)}),b.subscribe("mbs.performlist.stop."+c._vars.id,function(){c._vars.isStarted!==!1&&(c.stop(),c._vars.isStarted=!1)}),b.subscribe("mbs.performlist.ready."+c._vars.id,function(){c._options.autoStartAfterReady===!0&&b.publish("mbs.performlist.start."+c._vars.id)}),"function"==typeof window.IScroll&&"function"!=typeof window.iScroll&&(window.iScroll=IScroll),this._loadPlugins(),void 0)},e.prototype.getListElement=function(){var a=this;return a._vars.listElement},e.prototype.getId=function(){var a=this;return a._vars.id},e.prototype.start=function(){var a=this;if("function"==typeof window.iScroll){var b=null;"undefined"!=typeof a._vars.listElement.iScroll&&a._vars.listElement.iScroll instanceof window.iScroll&&(b=a._vars.listElement.iScroll),null!==b&&"function"==typeof $&&(b=$(a._vars.listElement).data("iscroll")),b instanceof window.iScroll&&(a._vars.iScrollInst=a._vars.listElement.iScroll=b)}null===a._vars.iScrollInst&&a._vars.listElement.classList.contains("browser-scroll")===!1&&a._vars.listElement.classList.add("browser-scroll"),a._listToListItemClick(a._vars.listElement),a._vars.scrollingStatusId=this._enableScrollingStatus(),a._vars._cb_afterListResize=function(){a._onListResize()},a._vars.listElement.addEventListener("resize",a._vars._cb_afterListResize,!1),a._startListeners()},e.prototype.stop=function(){var a=this;null!==a._vars.fastButtonListInst&&(a._vars.fastButtonListInst.destroy(a._vars.listElement),a._vars.fastButtonListInst=null),a._vars.scrollingStatusId>0&&window.clearInterval(a._vars.scrollingStatusId),a._vars.listElement.removeEventListener("resize",a._vars._cb_afterListResize,!1),a._stopListeners()},e.prototype.setData=function(a){var b=this;if(a instanceof Array)b._vars.itemsType="array",b._options.categoryType="ul",b._options.itemType="li",null!==b._vars.filter&&(b._vars.filter.destroy(),b._vars.filter=null),this._buildItemsAsArray(a);else{if(!(a instanceof Object))return d.error("Provided data is not an array not an object"),!1;b._vars.itemsType="object",b._options.dependsOnUlLi===!1&&(b._options.categoryType="dl",b._options.titleType="dt",b._options.itemType="dd"),this._buildItemsAsObject(a),null!==b._vars.filter&&b._vars.filter.addListSpaceForFilterElement(c)}if(this._buildListScroller(),null!==b._vars.optimizer?b._vars.optimizer.loadFromElement(b._vars.scrollerElement):this._buildFullListItems(),null!==b._vars.filter){var c=b._vars.listElement.querySelectorAll(this._getClassName("category-title [data-letter]",!0));b._vars.filter.setTitleElements(c)}return!0},e.prototype._getClassName=function(a,b){var c=this;if("string"!=typeof a&&""!==a)return d.error("Invalid parameter",a),"";var e=c._options.cssPrefix+"-"+a;return b===!0&&(e="."+e),e},e.prototype._buildItemsAsArray=function(a){var b=this;if(a instanceof Array==!1)return d.error("Invalid parameter",a),!1;var c=document.createElement(b._options.itemType);c.classList.add(this._getClassName("category-item"));for(var e=a.length,f=0;e>f;f++){var g=c.cloneNode();g.innerHTML=a[f],b._vars.listItems.push(g)}},e.prototype._buildItemsAsObject=function(a){var b=this;if(a instanceof Object==!1)return d.error("Invalid parameter",a),!1;var c=document.createElement(b._options.titleType);c.classList.add(this._getClassName("category-title")),""!==b._options.categoryTitleExtraClass&&c.classList.add(b._options.categoryTitleExtraClass);var e=document.createElement(b._options.itemType);e.classList.add(this._getClassName("category-item")),""!==b._options.categoryItemExtraClass&&e.classList.add(b._options.categoryItemExtraClass);for(var f in a){var g=document.createDocumentFragment(),h=c.cloneNode();b._options.useFilters===!0?(h.innerHTML=b._vars.filter.createTitleHTML(f),b._vars.filter.addTitleItem(f)):h.innerHTML=f,g.appendChild(h);for(var i=0;i<a[f].length;i++){var j=e.cloneNode();j.innerHTML=a[f][i],g.appendChild(j)}b._vars.listItems.push(g)}},e.prototype._buildListScroller=function(){var a,b=this;a=null!==b._options.listScrollerElement?b._options.listScrollerElement:document.createElement(b._options.categoryType),a.classList.add(this._getClassName(b._options.listScroller)),""!==b._options.listScrollerExtraClass&&a.classList.add(b._options.listScrollerExtraClass),a.innerHTML="Building...",b._vars.listElement.innerText="",b._vars.listElement.appendChild(a),null!==b._vars.preventPageScroller&&b._vars.isIOS===!0&&b._vars.preventPageScroller.preventScrollingOnListParent(b._vars.listElement),b._vars.scrollerElement=a},e.prototype._buildFullListItems=function(){for(var a=this,c=document.createDocumentFragment(),d=a._vars.listItems.length,e=0;d>e;e++){var f=a._vars.listItems[e];c.appendChild(f)}a._vars.scrollerElement.innerHTML="",a._vars.scrollerElement.appendChild(c),b.publish("mbs.performlist.ready."+a._vars.id)},e.prototype._enableScrollingStatus=function(){function a(){c=null!==b._vars.iScrollInst?parseInt(b._vars.iScrollInst.y):b._vars.listElement.scrollTop;var a=c===e;a!==f&&(f=a,f===!0?(g>0&&(window.clearTimeout(g),g=0),g=window.setTimeout(function(){b._vars.listElement.removeAttribute("is-scrolling")},300)):b._vars.listElement.setAttribute("is-scrolling","")),e=c}var b=this;if("number"!=typeof b._vars.listElement.scrollTop)return d.error("This item is not a scrolling list"),void 0;var c=0,e=0,f=!1,g=0;return window.setInterval(a,20)},e.prototype._listToListItemClick=function(a){function e(a){if(a.type!==h)return a.preventDefault(),a.stopPropagation(),d.log("--- event canceled! (not "+h+") ---"),void 0;var e=c.findParentNodeWithClassName(a.target.parentNode,f._getClassName(f._options.listContainer));if(null!==e){var g=null!==e.getAttribute("is-disabled"),i=null!==e.getAttribute("is-scrolling");if(i===!0)return d.log("--- event canceled! (scrolling) ---"),a.preventDefault(),a.stopPropagation(),void 0;if(g===!0)return d.log("--- event canceled! (disabled) ---"),a.preventDefault(),a.stopPropagation(),void 0}var j=c.findParentNodeWithNodeName(a.target,f._options.itemType);if(null!==j){var k={target:a.target,listItem:j};b.publish("mbs.performlist.click."+f._vars.id,k)}}var f=this,g="ontouchend"in document,h=g===!0?"touchend":"click";f._vars.fastButtonListInst=new MBP.fastButton(a,e)},e.prototype._loadPlugins=function(){var a=this,b=!0;a._vars.pluginsToLoad=[],a._vars.pluginsToLoad.filter=!1,a._vars.pluginsToLoad.optimizer=!1,a._vars.pluginsToLoad.preventPageScroller=!1,a._options.useOptimizer===!0&&(b=!1,require(["perform-list/perform-list-optimizer"],function(b){a._vars.optimizer=new b;var c={id:a._vars.id,listElement:a._vars.listElement,scrollerElement:a._vars.listScroller,listItems:a._vars.listItems};a._vars.optimizer.init(c),a._vars.pluginsToLoad.optimizer=!0,a._areAllPluginsLoaded()})),a._options.useFilters===!0&&(b=!1,require(["perform-list/perform-list-filter"],function(b){a._vars.filter=new b;var c={id:a._vars.id,listElement:a._vars.listElement};a._vars.filter.init(c),a._vars.pluginsToLoad.filter=!0,a._areAllPluginsLoaded()})),a._options.usePreventPageScroller===!0&&(b=!1,require(["perform-list/perform-list-prevent-page-scroll"],function(b){a._vars.preventPageScroller=b,a._vars.pluginsToLoad.preventPageScroller=!0,a._areAllPluginsLoaded()})),b===!0&&a._areAllPluginsLoaded()},e.prototype._areAllPluginsLoaded=function(){var a=this;a._options.useOptimizer===a._vars.pluginsToLoad.optimizer&&a._options.useFilters===a._vars.pluginsToLoad.filter&&a._options.usePreventPageScroller===a._vars.pluginsToLoad.preventPageScroller&&window.setTimeout(function(){b.publish("mbs.performlist.initialized."+a._vars.id)},0)},e.prototype._onListResize=function(){},e.prototype._startListeners=function(){var a=this,c=0,d={width:0,height:0};a._vars._cb_afterWindowResize=function(){c>0&&(window.clearTimeout(c),c=0),c=window.setTimeout(function(){if(null!==a._vars.listElement){var c=window.getComputedStyle(a._vars.listElement,null),e=!1;d.width!==c.width&&(e=!0,d.width=c.width),d.height!==c.height&&(e=!0,d.height=c.height),e===!0&&b.publish("mbs.performlist.resize."+a._vars.id)}},500)},window.addEventListener("resize",a._vars._cb_afterWindowResize,!1)},e.prototype._stopListeners=function(){var a=this;document.removeEventListener("resize",a._vars._cb_afterWindowResize,!1)},e});